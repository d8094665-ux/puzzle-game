<script>
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

const imageInput = document.getElementById('imageInput');
const startBtn = document.getElementById('startBtn');
const puzzleEl = document.getElementById('puzzle');

const startScreen = document.getElementById('startScreen');
const gameScreen = document.getElementById('gameScreen');
const successScreen = document.getElementById('successScreen');

let pieces = [];
let draggedIndex = null;

imageInput.onchange = () => startBtn.disabled = !imageInput.files.length;

startBtn.onclick = () => {
  startScreen.classList.add('hidden');
  gameScreen.classList.remove('hidden');
  initPuzzle();
};

function initPuzzle() {
  const img = new Image();
  img.src = URL.createObjectURL(imageInput.files[0]);

  img.onload = () => {
    puzzleEl.innerHTML = '';
    pieces = [...Array(9).keys()];
    shuffle(pieces);

    pieces.forEach((pos, index) => {
      const piece = document.createElement('div');
      piece.className = 'piece';
      piece.dataset.index = index;
      piece.dataset.current = pos;

      updateBG(piece);

      piece.addEventListener('pointerdown', e => {
        draggedIndex = Number(piece.dataset.index);
        piece.style.opacity = '0.6';
      });

      piece.addEventListener('pointerup', e => {
        const targetIndex = getIndexFromEvent(e);
        piece.style.opacity = '1';

        if (targetIndex !== null && targetIndex !== draggedIndex) {
          swapPieces(draggedIndex, targetIndex);
          renderPuzzle();

          if (checkWin()) setTimeout(showSuccess, 300);
        }

        draggedIndex = null;
      });

      puzzleEl.appendChild(piece);
    });
  };
}

function getIndexFromEvent(e) {
  const rect = puzzleEl.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if (x < 0 || y < 0 || x > rect.width || y > rect.height) return null;

  const col = Math.floor(x / (rect.width / 3));
  const row = Math.floor(y / (rect.height / 3));

  return row * 3 + col;
}

function swapPieces(a, b) {
  [pieces[a], pieces[b]] = [pieces[b], pieces[a]];
}

function renderPuzzle() {
  [...puzzleEl.children].forEach((piece, index) => {
    piece.dataset.index = index;
    piece.dataset.current = pieces[index];
    updateBG(piece);
  });
}

function updateBG(piece) {
  const pos = piece.dataset.current;
  piece.style.backgroundImage = `url(${URL.createObjectURL(imageInput.files[0])})`;
  piece.style.backgroundSize = '300% 300%';
  piece.style.backgroundPosition =
    `${(pos % 3) * 50}% ${Math.floor(pos / 3) * 50}%`;
}

function checkWin() {
  return pieces.every((v, i) => v === i);
}

function showSuccess() {
  gameScreen.classList.add('hidden');
  successScreen.classList.remove('hidden');
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function goToBooking() {
  window.location.href = 'https://example.com';
}
</script>
