<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 420px;
      padding: 16px;
      text-align: center;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 10px;
    }

    button {
      padding: 14px;
      width: 100%;
      border: none;
      border-radius: 10px;
      background: #2f80ed;
      color: #fff;
      font-size: 16px;
      margin-top: 12px;
    }

    .hidden { display: none; }

    input[type="file"] {
      margin-top: 12px;
    }

    .puzzle {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      margin-top: 15px;
      position: relative;
    }

    .piece {
      width: 100%;
      aspect-ratio: 1 / 1;
      background-size: 300% 300%;
      border-radius: 4px;
      touch-action: none;
      cursor: grab;
    }

    .piece.dragging {
      position: absolute;
      z-index: 10;
      cursor: grabbing;
      opacity: 0.9;
      transform: scale(1.05);
    }

    .success {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
    }

    .promo {
      font-size: 20px;
      color: #27ae60;
      font-weight: bold;
      margin: 10px 0;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- START -->
  <div id="startScreen">
    <h1>üß© –°–æ–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É</h1>
    <p>–ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤ –∏ —Å–æ–±–µ—Ä–∏ –ø–∞–∑–ª</p>
    <input type="file" id="imageInput" accept="image/*">
    <button id="startBtn" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  </div>

  <!-- GAME -->
  <div id="gameScreen" class="hidden">
    <h1>–ü–µ—Ä–µ—Ç–∞—â–∏ —ç–ª–µ–º–µ–Ω—Ç—ã</h1>
    <div class="puzzle" id="puzzle"></div>
  </div>

  <!-- SUCCESS -->
  <div id="successScreen" class="hidden">
    <div class="success">
      <h1>üéâ –ì–æ—Ç–æ–≤–æ!</h1>
      <p>–¢—ã –ø–æ–ª—É—á–∞–µ—à—å:</p>
      <div class="promo">–°–∫–∏–¥–∫–∞ 5%</div>
      <p>–ü—Ä–æ–º–æ–∫–æ–¥: <b>MOSCOW5</b></p>
      <button onclick="goToBooking()">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>

</div>

<script>
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

const imageInput = document.getElementById('imageInput');
const startBtn = document.getElementById('startBtn');
const puzzleEl = document.getElementById('puzzle');

const startScreen = document.getElementById('startScreen');
const gameScreen = document.getElementById('gameScreen');
const successScreen = document.getElementById('successScreen');

let draggedPiece = null;
let startX = 0;
let startY = 0;

imageInput.onchange = () => startBtn.disabled = !imageInput.files.length;

startBtn.onclick = () => {
  startScreen.classList.add('hidden');
  gameScreen.classList.remove('hidden');
  initPuzzle();
};

function initPuzzle() {
  const img = new Image();
  img.src = URL.createObjectURL(imageInput.files[0]);

  img.onload = () => {
    puzzleEl.innerHTML = '';
    const order = [...Array(9).keys()];
    shuffle(order);

    order.forEach((pos, index) => {
      const piece = document.createElement('div');
      piece.className = 'piece';
      piece.dataset.correct = index;
      piece.dataset.current = pos;

      const x = pos % 3;
      const y = Math.floor(pos / 3);

      piece.style.backgroundImage = `url(${img.src})`;
      piece.style.backgroundPosition = `${x * 50}% ${y * 50}%`;

      piece.addEventListener('pointerdown', onDragStart);
      puzzleEl.appendChild(piece);
    });
  };
}

function onDragStart(e) {
  draggedPiece = e.target;
  draggedPiece.setPointerCapture(e.pointerId);

  const rect = draggedPiece.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;

  draggedPiece.classList.add('dragging');
  draggedPiece.style.width = rect.width + 'px';
  draggedPiece.style.height = rect.height + 'px';
}

document.addEventListener('pointermove', e => {
  if (!draggedPiece) return;

  draggedPiece.style.left = (e.clientX - startX - puzzleEl.getBoundingClientRect().left) + 'px';
  draggedPiece.style.top = (e.clientY - startY - puzzleEl.getBoundingClientRect().top) + 'px';
});

document.addEventListener('pointerup', e => {
  if (!draggedPiece) return;

  draggedPiece.classList.remove('dragging');
  draggedPiece.style.left = '';
  draggedPiece.style.top = '';
  draggedPiece.style.width = '';
  draggedPiece.style.height = '';

  const target = document.elementFromPoint(e.clientX, e.clientY);
  if (target && target.classList.contains('piece') && target !== draggedPiece) {
    swap(draggedPiece, target);
    if (checkWin()) setTimeout(showSuccess, 300);
  }

  draggedPiece = null;
});

function swap(a, b) {
  const temp = a.dataset.current;
  a.dataset.current = b.dataset.current;
  b.dataset.current = temp;

  updateBG(a);
  updateBG(b);
}

function updateBG(piece) {
  const pos = piece.dataset.current;
  piece.style.backgroundPosition =
    `${(pos % 3) * 50}% ${Math.floor(pos / 3) * 50}%`;
}

function checkWin() {
  return [...document.querySelectorAll('.piece')]
    .every(p => p.dataset.correct === p.dataset.current);
}

function showSuccess() {
  gameScreen.classList.add('hidden');
  successScreen.classList.remove('hidden');
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function goToBooking() {
  window.location.href = 'https://example.com';
}
</script>
</body>
</html>
