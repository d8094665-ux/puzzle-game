<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–æ–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: #1e1e1e;
  color: #ffffff;
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  display: flex;
  justify-content: center;
}

.app {
  width: 100%;
  max-width: 420px;
  padding: 16px;
  text-align: center;
}

h1 {
  font-size: 22px;
  margin-bottom: 10px;
}

p {
  opacity: 0.85;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 14px;
  background: #2f80ed;
  border: none;
  border-radius: 10px;
  color: #fff;
  font-size: 16px;
}

button:active {
  transform: scale(0.98);
}

.hidden {
  display: none;
}

.preview {
  width: 100%;
  border-radius: 12px;
  margin-top: 12px;
}

.puzzle {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 2px;
  margin-top: 16px;
}

.piece {
  width: 100%;
  aspect-ratio: 1 / 1;
  background-size: 300% 300%;
  border-radius: 4px;
  touch-action: none;
}

.piece:active {
  opacity: 0.7;
}

.success-box {
  background: #2a2a2a;
  padding: 20px;
  border-radius: 14px;
}

.promo {
  font-size: 20px;
  font-weight: bold;
  color: #27ae60;
  margin: 10px 0;
}
</style>
</head>

<body>
<div class="app">

<!-- START -->
<div id="startScreen">
  <h1>üß© –°–æ–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É</h1>
  <p>–°–æ–±–µ—Ä–∏ –ø–∞–∑–ª –∏ –ø–æ–ª—É—á–∏ –±–æ–Ω—É—Å –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
  <img id="preview" class="preview">
  <button id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<!-- GAME -->
<div id="gameScreen" class="hidden">
  <h1>–ü–µ—Ä–µ—Ç–∞—â–∏ —ç–ª–µ–º–µ–Ω—Ç—ã</h1>
  <div class="puzzle" id="puzzle"></div>
</div>

<!-- SUCCESS -->
<div id="successScreen" class="hidden">
  <div class="success-box">
    <h1>üéâ –ì–æ—Ç–æ–≤–æ!</h1>
    <p>–¢–≤–æ–π –±–æ–Ω—É—Å:</p>
    <div class="promo">–°–∫–∏–¥–∫–∞ 5%</div>
    <p>–ü—Ä–æ–º–æ–∫–æ–¥: <b>MOSCOW5</b></p>
    <button onclick="goToBooking()">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>

</div>

<script>
/* Telegram */
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

/* ===== –ù–ê–°–¢–†–û–ô–ö–ò ===== */

// –º–∞—Å—Å–∏–≤ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
const presetImages = [
  "images/apt1.jpg",
  "images/apt2.jpg",
  "images/apt3.jpg",
  "images/apt4.jpg"
];

// —Å—Å—ã–ª–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const BOOKING_URL = "https://example.com";

/* ===================== */

const selectedImage =
  presetImages[Math.floor(Math.random() * presetImages.length)];

document.getElementById("preview").src = selectedImage;

const startScreen = document.getElementById("startScreen");
const gameScreen = document.getElementById("gameScreen");
const successScreen = document.getElementById("successScreen");
const puzzleEl = document.getElementById("puzzle");

let pieces = [];
let draggedIndex = null;

document.getElementById("startBtn").onclick = () => {
  startScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
  initPuzzle();
};

function initPuzzle() {
  pieces = [...Array(9).keys()];
  shuffle(pieces);
  renderPuzzle();
}

function renderPuzzle() {
  puzzleEl.innerHTML = "";

  pieces.forEach((pos, index) => {
    const piece = document.createElement("div");
    piece.className = "piece";
    piece.dataset.index = index;
    piece.dataset.current = pos;

    updateBG(piece);

    piece.addEventListener("pointerdown", () => {
      draggedIndex = index;
    });

    piece.addEventListener("pointerup", e => {
      const targetIndex = getIndexFromEvent(e);
      if (targetIndex !== null && targetIndex !== draggedIndex) {
        swap(draggedIndex, targetIndex);
        renderPuzzle();
        if (checkWin()) setTimeout(showSuccess, 300);
      }
      draggedIndex = null;
    });

    puzzleEl.appendChild(piece);
  });
}

function updateBG(piece) {
  const pos = piece.dataset.current;
  piece.style.backgroundImage = `url(${selectedImage})`;
  piece.style.backgroundPosition =
    `${(pos % 3) * 50}% ${Math.floor(pos / 3) * 50}%`;
}

function getIndexFromEvent(e) {
  const rect = puzzleEl.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  if (x < 0 || y < 0 || x > rect.width || y > rect.height) return null;
  const col = Math.floor(x / (rect.width / 3));
  const row = Math.floor(y / (rect.height / 3));
  return row * 3 + col;
}

function swap(a, b) {
  [pieces[a], pieces[b]] = [pieces[b], pieces[a]];
}

function checkWin() {
  return pieces.every((v, i) => v === i);
}

function showSuccess() {
  gameScreen.classList.add("hidden");
  successScreen.classList.remove("hidden");
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function goToBooking() {
  window.location.href = BOOKING_URL;
}
</script>
</body>
</html>
